sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/m/GroupHeaderListItem","sap/ui/Device","sap/ui/core/Fragment","../model/formatter"],function(e,t,s,i,r,o,a,n,l){"use strict";var u="";var g=[];return e.extend("invoiceapproval_S4Hana.controller.Master",{formatter:l,onInit:function(){var e=this.byId("list"),t=this._createViewModel(),s=e.getBusyIndicatorDelay();e.setBusy(true);var i=this;sap.ui.getCore().this=this;Promise.all([this.getTaskProcessing()]).then(i.getInvoiceProperties.bind(i));this._oList=e;this._oListFilterState={aFilter:[],aSearch:[]};this.setModel(t,"masterView");e.attachEventOnce("updateFinished",function(){t.setProperty("/delay",s)});this.getView().addEventDelegate({onBeforeFirstShow:function(){this.getOwnerComponent().oListSelector.setBoundMasterList(e)}.bind(this)});this.getRouter().getRoute("master").attachPatternMatched(this._onMasterMatched,this);this.getRouter().attachBypassed(this.onBypassed,this);var r=this.getOwnerComponent().getEventBus();r.subscribe("Detail","selectFirstItemAfter",this.selectFirstItemAfter,this)},displayFirst:function(e){var t=this.getView().byId("list").getItems();var s="";if(t){s=t[0];if(s!=undefined){this._showDetail(s)}}},selectFirstItemAfter:function(){var e=!a.system.phone;var t=this;sap.ui.getCore().this=this;Promise.all([this.getTaskProcessing()]).then(t.getInvoiceProperties.bind(t));this.getRouter().getTargets().display("detailObjectNotFound")},refreshData:function(){oList.setBusy(true);var e=this;sap.ui.getCore().this=this;Promise.all([this.getTaskProcessing()]).then(e.getInvoiceProperties.bind(e))},getInvoiceProperties:function(e){var s=this.getOwnerComponent().getModel();s.read("/ExtendedPropertiesInvoiceSet",{filters:[g],success:function e(s,i){var r=0,o=0,a=[],n={};a=[];for(r=0;r<s.results.length;r++){for(o=0;o<sap.ui.getCore().TaskProcessingResult.length;o++){if(s.results[r].InstanceID==sap.ui.getCore().TaskProcessingResult[o].InstanceID){n={};n.DocTypeDesc=s.results[r].DocTypeDesc;n.InstanceID=s.results[r].InstanceID;n.VendorName=s.results[r].VendorName;n.InvoiceNumber=s.results[r].InvoiceNumber;n.Date=s.results[r].Date;n.NetAmount=s.results[r].NetAmount;n.ToBeApproved=s.results[r].ToBeApproved;n.Currency=s.results[r].Currency;n.TaskDefinitionID=sap.ui.getCore().TaskProcessingResult[o].TaskDefinitionID;n.CreatedBy=sap.ui.getCore().TaskProcessingResult[o].CreatedBy;n.Priority=sap.ui.getCore().TaskProcessingResult[o].Priority;n.Title=sap.ui.getCore().TaskProcessingResult[o].Title;n.DueOn=sap.ui.getCore().TaskProcessingResult[o].DueOn;n.CreatedOn=sap.ui.getCore().TaskProcessingResult[o].CreatedOn;n.Status=sap.ui.getCore().TaskProcessingResult[o].Status;n.Reservation=sap.ui.getCore().TaskProcessingResult[o].Reservation;n.Type=sap.ui.getCore().TaskProcessingResult[o].Type;a.push(n)}}}var l={Task:a};var u=new sap.ui.model.json.JSONModel(l);sap.ui.core.BusyIndicator.hide();sap.ui.getCore().this.getOwnerComponent().setModel(u,"modelMaster");var g=new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:sap.ui.getCore().this.getResourceBundle().getText("masterTitleCount",[s.results.length]),noDataText:sap.ui.getCore().this.getResourceBundle().getText("masterListNoDataText"),sortBy:"PurchaseRequisition",groupBy:"None"});sap.ui.getCore().this.getView().setModel(g,"masterView");if(sap.ui.getCore().this.getView().byId("list")!=undefined){sap.ui.getCore().this.getView().byId("list").setBusy(false);sap.ui.getCore().this.displayFirst()}},error:function e(s){var i=new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:sap.ui.getCore().this.getResourceBundle().getText("masterTitleCount",[0]),noDataText:sap.ui.getCore().this.getResourceBundle().getText("masterListNoDataText"),sortBy:"PurchaseRequisition",groupBy:"None"});sap.ui.core.BusyIndicator.hide();sap.ui.getCore().this.getView().setModel(i,"masterView");sap.ui.getCore().this.getView().byId("list").setBusy(false)}})},getTaskProcessing:function(e){var t={};var s=0;var i=0;sap.ui.getCore().this=this;var r=this.getOwnerComponent().getModel("TASKPROCESSING");r.refresh();g=[];sap.ui.core.BusyIndicator.show();return new Promise(function(e,t){r.read("/TaskCollection?$skip=0&$top=9999&$orderby=CreatedOn%20asc&$filter=TaskDefinitionID eq 'TS90000087_WS00275253_0000000071' and (Status eq 'READY' or Status eq 'RESERVED' or Status eq 'IN_PROGRESS' or Status eq 'EXECUTED')",{success:function t(i,r){var o=i.results;sap.ui.getCore().TaskProcessingResult=[];for(s=0;s<o.length;s++){if((o[s].TaskDefinitionID=="TS90000090_WS00275264_0000000182"||o[s].TaskDefinitionID=="TS90000087_WS00275253_0000000071"||o[s].TaskDefinitionID=="TS00008267_WS00275253_0000000083"||o[s].TaskDefinitionID=="TS00275278"||o[s].TaskDefinitionID=="TS00008267_WS00275264_0000000213")&&(o[s].Status=="READY"||o[s].Status=="RESERVED"||o[s].Status=="IN_PROGRESS"||o[s].Status=="EXECUTED")){var a=new sap.ui.model.Filter("InstanceID",sap.ui.model.FilterOperator.EQ,o[s].InstanceID);g.push(a);sap.ui.getCore().TaskProcessingResult.push(o[s])}}e(i)},error:function e(s){sap.ui.core.BusyIndicator.hide();t(s)}})})},onUpdateFinished:function(e){this._updateListItemCount(e.getParameter("total"))},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.refreshData();return}var t=e.getParameter("query");if(t){this._oListFilterState.aSearch=new s({filters:[new s("PurchaseRequisition",r.Contains,t),new s("TipoDocumentoDesc",r.Contains,t),new s("RequesterDesc",r.Contains,t),new s("TotalValue",r.Contains,t),new s("Currency",r.Contains,t)],and:false})}else{this._oListFilterState.aSearch=[]}var i=this._oListFilterState.aSearch,o=this.getModel("masterView");this._oList.getBinding("items").filter(i,"Application");if(i.length!==0){o.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataWithFilterOrSearchText"))}else if(this._oListFilterState.aSearch.length>0){o.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataText"))}},onRefresh:function(){this._oList.getBinding("items").refresh()},onOpenViewSettings:function(e){var t="filter";if(e.getSource()instanceof sap.m.Button){var s=e.getSource().getId();if(s.match("sort")){t="sort"}else if(s.match("group")){t="group"}}if(!this.byId("viewSettingsDialog")){n.load({id:this.getView().getId(),name:"invoiceapproval_S4Hana.view.ViewSettingsDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewSettingsDialog").open(t)}},onOpenViewFilter:function(e){var t="filter";if(!this.byId("viewFilterDialog")){n.load({id:this.getView().getId(),name:"invoiceapproval_S4Hana.view.FilterDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewFilterDialog").open(t)}},onOpenGroupFilter:function(e){var t="Group";if(!this.byId("viewGroupDialog")){n.load({id:this.getView().getId(),name:"invoiceapproval_S4Hana.view.GroupFilter",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open(t)}.bind(this))}else{this.byId("viewGroupDialog").open(t)}},onConfirmViewSettingsDialog:function(e){this._applySortGroup(e)},_applySortGroup:function(e){var t=e.getParameters(),s,r,o=[];s=t.sortItem.getKey();r=t.sortDescending;o.push(new i(s,r));this._oList.getBinding("items").sort(o)},onSelectionChange:function(e){var t=e.getSource(),s=e.getParameter("selected");if(!(t.getMode()==="MultiSelect"&&!s)){this._showDetail(e.getParameter("listItem")||e.getSource())}},onBypassed:function(){this._oList.removeSelections(true)},createGroupHeader:function(e){return new o({title:e.text,upperCase:false})},onNavBack:function(){history.go(-1)},_createViewModel:function(){return new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:this.getResourceBundle().getText("masterTitleCount",[0]),noDataText:this.getResourceBundle().getText("masterListNoDataText"),sortBy:"PurchaseRequisition",groupBy:"None"})},_onMasterMatched:function(){this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded")},_showDetail:function(e){var t=!a.system.phone;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("object",{objectId:e.getContent()[0].getItems()[0].getItems()[3].getText(),instanceId:e.getContent()[0].getItems()[0].getItems()[2].getText()},t)},_updateListItemCount:function(e){var t;if(this._oList.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("masterTitleCount",[e]);this.getModel("masterView").setProperty("/title",t)}},_applyFilterSearch:function(){var e=this._oListFilterState.aSearch.concat(this._oListFilterState.aFilter),t=this.getModel("masterView");this._oList.getBinding("items").filter(e,"Application");if(e.length!==0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataWithFilterOrSearchText"))}else if(this._oListFilterState.aSearch.length>0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataText"))}},_updateFilterBar:function(e){var t=this.getModel("masterView");t.setProperty("/isFilterBarVisible",this._oListFilterState.aFilter.length>0);t.setProperty("/filterBarLabel",this.getResourceBundle().getText("masterFilterBarText",[e]))}})});